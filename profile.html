<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Profile Builder (DSL → UI)</title>
  <style>
    :root{--bg:#0e0f12;--card:#14161b;--muted:#8a8f98;--text:#e8eaee;--accent:#8aa0ff;--border:#242733}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .row{display:grid;grid-template-columns:1fr;gap:18px}
    @media(min-width:960px){.row{grid-template-columns:340px 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.35)}
    .card h2,.card h3{margin:0 0 6px 0}
    .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border)}
    .body{padding:16px 18px}
    textarea,input,select{background:#0c0d10;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
    textarea{width:100%;resize:vertical}
    .muted{color:var(--muted)}
    .btn{background:#171a22;border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.secondary{background:#0c0d10}
    .btn.accent{background:var(--accent);border-color:transparent;color:#101217}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .grid.two{grid-template-columns:1fr}
    @media(min-width:740px){.grid.two{grid-template-columns:1fr 1fr}}
    .q{display:flex;flex-direction:column;gap:8px}
    .q label{font-weight:600}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--border);background:#0c0d10;padding:8px 10px;border-radius:24px;cursor:pointer}
    .chip.active{background:var(--accent);color:#101217;border-color:transparent}
    .toggle{width:46px;height:26px;border-radius:20px;background:#2b3040;position:relative;border:1px solid var(--border);cursor:pointer}
    .toggle .knob{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#e9ecf5;transition:transform .18s ease}
    .toggle.on{background:var(--accent)} .toggle.on .knob{transform:translateX(20px)}
    .steplist{display:flex;flex-direction:column;gap:8px}
    .step{padding:10px 12px;border:1px solid var(--border);border-radius:12px;cursor:pointer;background:#0c0d10}
    .step.active{outline:2px solid var(--accent)}
    .summary{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:740px){.summary{grid-template-columns:1fr 1fr}}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#202433;border:1px solid var(--border);margin-right:6px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0c0d10;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">

      <!-- Left: DSL + Steps + Actions -->
      <div class="col">
        <div class="card">
          <div class="head"><h2>Paste Your DSL</h2><span class="muted small">FORM / SECTION / Q / END</span></div>
          <div class="body">
            <textarea id="dsl" rows="12" class="mono" placeholder="Paste your line-based DSL here…"></textarea>
            <div class="row-actions" style="margin-top:10px">
              <button id="parseBtn" class="btn accent">Parse & Render</button>
              <button id="loadDemo" class="btn">Load Minimal Demo</button>
              <button id="saveDSL" class="btn">Save DSL</button>
              <button id="clearDSL" class="btn secondary">Clear</button>
            </div>
            <div class="muted small" style="margin-top:8px">No build, no dependencies. Runs fully client-side on GitHub Pages.</div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div class="head"><h3>Sections</h3><span class="muted small">Click to jump</span></div>
          <div class="body">
            <div id="steps" class="steplist"></div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div class="head"><h3>Exports</h3></div>
          <div class="body">
            <div class="row-actions">
              <button id="exportJSON" class="btn">Export JSON</button>
              <button id="exportMD" class="btn">Export Markdown</button>
              <button id="resetAnswers" class="btn secondary">Reset Answers</button>
            </div>
            <div class="muted small" style="margin-top:8px">Answers autosave to <span class="kbd">localStorage</span>.</div>
          </div>
        </div>
      </div>

      <!-- Right: Form + Summary -->
      <div class="col">
        <div class="card">
          <div class="head">
            <div>
              <div class="muted small" id="sectionMeta">Section 0 of 0</div>
              <h2 id="sectionTitle">No Section</h2>
            </div>
            <div class="row-actions">
              <button id="prev" class="btn secondary">Back</button>
              <button id="next" class="btn">Next</button>
            </div>
          </div>
          <div class="body">
            <div id="form" class="grid two"></div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div class="head"><h3>Live Summary</h3><span class="muted small">Click fields above to edit</span></div>
          <div class="body">
            <div id="summary" class="summary"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const el = (tag, cls, txt) => { const n = document.createElement(tag); if (cls) n.className = cls; if (txt) n.textContent = txt; return n; };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };

  function download(name, text) {
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
  }

  // ---------- Parser ----------
  function parseAttrs(str){
    const attrs={};
    const re=/(\w+)=\"([^\"]*)\"|(\w+)=([^\s]+)/g; let m;
    while((m=re.exec(str))!==null){ if(m[1]) attrs[m[1]]=m[2]; else if(m[3]) attrs[m[3]]=m[4]; }
    return attrs;
  }

  function parseDSL(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = { form:{ keys:{} }, sections:[] };
    const sectionById = new Map(); let current=null;
    for(const line of lines){
      if(line.startsWith('FORM ')){
        out.form.keys = parseAttrs(line.slice(5));
      } else if(line.startsWith('SECTION ')){
        const a = parseAttrs(line.slice(8));
        current = { id:a.id, title:a.title||a.id, columns:parseInt(a.columns||'1',10), questions:[] };
        out.sections.push(current); sectionById.set(current.id,current);
      } else if(line.startsWith('Q ')){
        const a = parseAttrs(line.slice(2));
        const q = { type:a.type, id:a.id, section:a.section, label:a.label||a.id, options:a.options? a.options.split('|'):undefined, show_if:a.show_if||null };
        const target = sectionById.get(q.section)||current; if(!target) throw new Error('Unknown section: '+q.section);
        target.questions.push(q);
      } else if(line==='END'){ current=null; }
    }
    return out;
  }

  // ---------- Conditions ----------
  function evalShowIf(cond, answers){
    if(!cond) return true;
    const any = cond.match(/^(\w+):any_of:(.+)$/); if(any){
      const id=any[1], opts=any[2].split('|'); const v=answers[id];
      return Array.isArray(v) ? v.some(x=>opts.includes(String(x))) : opts.includes(String(v));
    }
    const eq = cond.match(/^(\w+):equals:(.+)$/); if(eq){
      const id=eq[1], expect=eq[2]; return String(answers[id])===expect;
    }
    return true;
  }

  // ---------- State ----------
  let schema = { sections:[] };
  let answers = load('profile_answers', {});
  let sectionIdx = 0;

  // ---------- Rendering ----------
  function renderSteps(){
    const steps = $('#steps'); steps.innerHTML='';
    schema.sections.forEach((s, i)=>{
      const b = el('button','step'+(i===sectionIdx?' active':''));
      b.textContent = s.title; b.onclick=()=>{sectionIdx=i; renderSection();}; steps.appendChild(b);
    });
  }

  function setAnswer(id, val){ answers[id]=val; save('profile_answers', answers); renderSummary(); }

  function inputText(q){
    const wrap = el('div','q'); const lab = el('label',null,q.label); const inp = el('input');
    inp.value = answers[q.id]||''; inp.oninput = ()=> setAnswer(q.id, inp.value);
    wrap.append(lab, inp); return wrap;
  }

  function inputTextarea(q){
    const wrap = el('div','q'); const lab = el('label',null,q.label); const ta = el('textarea');
    ta.rows=4; ta.value = answers[q.id]||''; ta.oninput=()=> setAnswer(q.id, ta.value);
    wrap.append(lab, ta); return wrap;
  }

  function inputToggle(q){
    const wrap = el('div','q'); const lab = el('label',null,q.label);
    const t = el('div','toggle'+(answers[q.id]? ' on':'')); const k = el('div','knob'); t.appendChild(k);
    t.onclick=()=>{ const v=!answers[q.id]; t.classList.toggle('on', v); setAnswer(q.id, v); renderSection(); };
    wrap.append(lab, t); return wrap;
  }

  function inputChips(q){
    const wrap = el('div','q'); const lab = el('label',null,q.label); const box = el('div','chips');
    const sel = Array.isArray(answers[q.id])? answers[q.id] : [];
    (q.options||[]).forEach(opt=>{
      const c = el('button','chip'+(sel.includes(opt)?' active':''), opt);
      c.onclick=()=>{
        const arr = Array.isArray(answers[q.id])? [...answers[q.id]] : [];
        const i = arr.indexOf(opt); if(i>=0) arr.splice(i,1); else arr.push(opt);
        setAnswer(q.id, arr); renderSection();
      };
      box.appendChild(c);
    });
    wrap.append(lab, box); return wrap;
  }

  function inputSelect(q){
    const wrap = el('div','q'); const lab = el('label',null,q.label); const sel = el('select');
    const def = el('option',null,'Select…'); def.disabled=true; def.selected = !(q.id in answers); def.value=''; sel.appendChild(def);
    (q.options||[]).forEach(opt=>{ const o = el('option',null,opt); o.value=opt; if(answers[q.id]===opt) o.selected=true; sel.appendChild(o); });
    sel.onchange=()=> setAnswer(q.id, sel.value);
    wrap.append(lab, sel); return wrap;
  }

  function inputMultiSelect(q){
    const wrap = el('div','q'); const lab = el('label',null,q.label); const box = el('div','chips');
    const sel = Array.isArray(answers[q.id])? answers[q.id] : [];
    (q.options||[]).forEach(opt=>{
      const c = el('button','chip'+(sel.includes(opt)?' active':''), opt);
      c.onclick=()=>{
        const arr = Array.isArray(answers[q.id])? [...answers[q.id]] : [];
        const i = arr.indexOf(opt); if(i>=0) arr.splice(i,1); else arr.push(opt);
        setAnswer(q.id, arr); renderSection();
      };
      box.appendChild(c);
    });
    wrap.append(lab, box); return wrap;
  }

  const renderers = { text:inputText, textarea:inputTextarea, toggle:inputToggle, chips:inputChips, select:inputSelect, multiselect:inputMultiSelect };

  function renderSection(){
    const sections = schema.sections; if(!sections.length){ $('#form').innerHTML=''; $('#sectionTitle').textContent='No Section'; $('#sectionMeta').textContent=''; return; }
    const sec = sections[sectionIdx];
    $('#sectionTitle').textContent = sec.title;
    $('#sectionMeta').textContent = `Section ${sectionIdx+1} of ${sections.length}`;
    const form = $('#form'); form.innerHTML = '';

    // grid columns
    form.className = 'grid ' + (sec.columns===2? 'two':'');

    // visible questions
    const qs = sec.questions.filter(q=> evalShowIf(q.show_if, answers));
    if(!qs.length){ form.appendChild(el('div','muted','No visible questions. Adjust toggles or complete prior steps.')); }
    qs.forEach(q=>{
      const renderer = renderers[q.type] || (()=> el('div','muted',`Unsupported type: ${q.type}`));
      form.appendChild(renderer(q));
    });

    renderSteps();
    renderSummary();
  }

  function renderSummary(){
    const box = $('#summary'); box.innerHTML='';
    schema.sections.forEach(sec=>{
      sec.questions.forEach(q=>{
        const v = answers[q.id]; if(v===undefined || v==='' || (Array.isArray(v)&&!v.length)) return;
        const card = el('div','card');
        const head = el('div','head'); const h = el('div'); h.innerHTML = `<div class="muted small">${sec.title}</div><strong>${q.label}</strong>`; head.appendChild(h); card.appendChild(head);
        const body = el('div','body');
        body.textContent = Array.isArray(v)? v.join(', ') : String(v);
        card.appendChild(body);
        box.appendChild(card);
      });
    });
  }

  // ---------- Markdown ----------
  function toMarkdown(){
    const lines = ['# Profile Summary',''];
    schema.sections.forEach(sec=>{
      lines.push(`## ${sec.title}`);
      sec.questions.forEach(q=>{
        const v = answers[q.id]; if(v===undefined || v==='' || (Array.isArray(v)&&!v.length)) return;
        lines.push(`- **${q.label}**: ${Array.isArray(v)? v.join(', '): String(v)}`);
      });
      lines.push('');
    });
    return lines.join('\n');
  }

  // ---------- Controls ----------
  $('#parseBtn').onclick = ()=>{ try{ schema = parseDSL($('#dsl').value); sectionIdx = 0; renderSection(); } catch(e){ alert('Parse error: '+e.message); } };
  $('#loadDemo').onclick = ()=>{
    const demo = `FORM key="universal"
SECTION id=baseline title="Universal Baseline" columns=2
Q type=text id=identity section=baseline label="Identity or label"
Q type=textarea id=purpose section=baseline label="Purpose or success criteria"
Q type=text id=time_horizon section=baseline label="Time anchors or horizon"
Q type=text id=context section=baseline label="Places or context"
Q type=textarea id=attributes section=baseline label="Key attributes, specs, traits"
Q type=chips id=preferences section=baseline label="Preferences or likes" options="Speed|Reliability|Cost|Simplicity|Aesthetics"
Q type=chips id=dislikes section=baseline label="Dislikes or constraints" options="Complexity|Noise|High Cost|Maintenance"
Q type=toggle id=ready_subjects section=baseline label="Ready for subject-specific probes?"
END
SECTION id=subjects title="Choose Subject" columns=1
Q type=select id=subject section=subjects label="Subject" options="Person|Product/Item"
Q type=toggle id=helper_tips section=subjects label="Show helper examples?"
END
SECTION id=person title="Person Probes" columns=2
Q type=chips id=interests section=person label="Interests" options="Music|Movies/TV|Books|Cooking|Travel|Fitness|Tech|Games|Sports" show_if="subject:any_of:Person"
Q type=select id=humor_style section=person label="Humor style" options="Dry|Witty|Slapstick|Sarcastic" show_if="subject:any_of:Person"
Q type=text id=aesthetics section=person label="Aesthetic preferences" show_if="subject:any_of:Person"
Q type=text id=nostalgia section=person label="Nostalgia window" show_if="helper_tips:equals:true"
END
SECTION id=product title="Product Probes" columns=2
Q type=select id=form_factor section=product label="Form factor" options="Handheld|Desktop|Wearable|Appliance|Tool|Other" show_if="subject:any_of:Product/Item|Product"
Q type=chips id=key_specs section=product label="Key specs" options="Power|Weight|Capacity|Speed|Runtime|Safety" show_if="subject:any_of:Product/Item|Product"
Q type=text id=compatibility section=product label="Compatibility" show_if="subject:any_of:Product/Item|Product"
Q type=chips id=budget_band section=product label="Budget band" options="<$50|$50–$199|$200–$499|$500+" show_if="subject:any_of:Product/Item|Product"
END`;
    $('#dsl').value = demo; save('profile_dsl', demo);
    schema = parseDSL(demo); sectionIdx=0; renderSection();
  };
  $('#saveDSL').onclick = ()=>{ save('profile_dsl', $('#dsl').value); alert('Saved to localStorage.'); };
  $('#clearDSL').onclick = ()=>{ $('#dsl').value=''; save('profile_dsl',''); };
  $('#exportJSON').onclick = ()=> download('profile.json', JSON.stringify(answers,null,2));
  $('#exportMD').onclick = ()=> download('profile.md', toMarkdown());
  $('#resetAnswers').onclick = ()=>{ answers={}; save('profile_answers', answers); renderSection(); };
  $('#prev').onclick = ()=>{ if(sectionIdx>0){ sectionIdx--; renderSection(); } };
  $('#next').onclick = ()=>{ if(sectionIdx<schema.sections.length-1){ sectionIdx++; renderSection(); } };

  // ---------- Init ----------
  (function init(){
    const cached = load('profile_dsl',''); if(cached) $('#dsl').value=cached;
    if($('#dsl').value.trim()) { try{ schema=parseDSL($('#dsl').value); }catch{} }
    renderSection(); renderSteps(); renderSummary();
  })();
  </script>
</body>
</html>
