<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>99 Nights ‚Äî Playbook</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#6ee7b7; --muted:#9aa8bb; --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#061226 0%, #07162a 100%); color:#e6f3f2;}
  .app{max-width:820px;margin:0 auto;padding:14px;box-sizing:border-box;display:flex;flex-direction:column;gap:12px;}
  header{display:flex;align-items:center;gap:12px;}
  h1{font-size:20px;margin:0;color:var(--accent)}
  .selector{background:var(--card);border-radius:14px;padding:12px;display:flex;gap:8px;align-items:center;width:100%;}
  .big-btn{background:var(--accent);color:#042023;border:none;padding:12px 16px;border-radius:12px;font-weight:700;font-size:16px;touch-action: manipulation;flex:1;}
  .big-icon-btn{background:transparent;border:2px solid var(--muted);color:var(--muted);padding:12px;border-radius:12px;font-size:18px;min-width:56px;}
  .day-display{font-size:18px;font-weight:700;color:#fff;padding:6px 12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));}
  .main-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:12px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);}
  .title{font-size:18px;font-weight:800;margin:6px 0;color:var(--accent);}
  .image-container{height:300px;background:var(--glass);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;margin-bottom:12px;}
  .image-container img{width:100%;height:100%;object-fit:contain;}
  textarea{width:100%;min-height:64px;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;resize:vertical;font-size:15px;}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px;}
  .action-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
  .muted{color:var(--muted);font-size:13px;}
  .footer{font-size:13px;color:var(--muted);text-align:center;padding:8px 0;}
</style>
</head>
<body>
<div class="app" role="application" aria-label="99 Nights Playbook">
  <header>
    <div style="flex:1">
      <h1>üå≤ 99 Nights ‚Äî Playbook</h1>
      <div class="muted">Scan items with QR codes to build your inventory!</div>
    </div>
    <div style="width:120px;text-align:right">
      <div class="day-display" id="selectedDayDisplay">Day 1</div>
    </div>
  </header>

  <section class="main-card">
    <div class="selector">
      <button class="big-icon-btn" id="prevBtn">‚óÄ</button>
      <select id="daySelect" style="flex:1;padding:12px;border-radius:10px;border:none;font-size:16px;"></select>
      <button class="big-icon-btn" id="nextBtn">‚ñ∂</button>
    </div>

    <div class="image-container">
      <img id="scenarioImage" src="" alt="Scenario Image" style="display:none;">
    </div>

    <div class="title" id="scenarioTitle">Scenario Title</div>

    <label for="itemsText">üß∞ Items</label>
    <textarea id="itemsText" readonly></textarea>

    <label for="locationText" style="margin-top:8px;">üìç Locations</label>
    <textarea id="locationText" readonly></textarea>

    <label for="missionText" style="margin-top:8px;">üéØ Mission / Instructions</label>
    <textarea id="missionText" readonly></textarea>

    <label for="inventoryText" style="margin-top:8px;">üéí Inventory</label>
    <textarea id="inventoryText" readonly></textarea>

    <div class="action-row">
      <button class="big-btn" id="startBtn">Start Mission ‚ñ∂</button>
      <button class="big-btn" id="previewBtn">Read Aloud üìù</button>
      <button class="big-btn" id="scanBtn">üì∑ Scan Item</button>
    </div>

    <div id="qr-reader" style="width:100%; max-width:400px; margin-top:12px; display:none;"></div>
  </section>

  <div class="footer">Made for adventures ‚Äî works offline. Only the current scenario's image is visible.</div>
</div>

<!-- QR code scanner library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
(() => {
  const scenarios = [
    {id:1,title:"Dawn of the Burrowers",items:"Nightstick, Whisper Map",locations:"Front Deck, Cul-de-sac",mission:"Patrol the cul-de-sac three times before sunup. Mark each burrow with a loud whistle. Return to the treehouse after each patrol.",image:"front_deck.jpg"},
    {id:2,title:"Mirror at the Lake",items:"Sky Mirror, Beacon Flash",locations:"Pool, Pool Deck",mission:"Walk the dock and describe three objects the Mirror shows. Use your voice to reflect the creatures back into the lake.",image:"pool.jpg"},
    {id:3,title:"The Floating Market",items:"Stories as currency",locations:"Gazebo, Front Deck",mission:"Roleplay a trader in the gazebo who trades glowing badges for stories. Tell three short tales to win a badge.",image:"gazebo.jpg"},
    {id:4,title:"The Nocturne Leap",items:"Sky Boots, Cloud Marker",locations:"Trampoline, Treehouse",mission:"Complete 10 controlled jumps on the trampoline, then climb to the treehouse and describe the Sky Bridge.",image:"trampoline.jpg"},
    {id:5,title:"Shadow Scout",items:"Echo Call, Quiet Boots",locations:"Cul-de-sac, Front Deck",mission:"Sneak from treehouse to front deck without making noise. If you are heard, freeze for 10 seconds and try again.",image:"culdesac.jpg"},
    {id:6,title:"The Gazebo Council",items:"Council Tokens, Voice Charm",locations:"Gazebo, Treehouse",mission:"Hold a council in the gazebo, appoint three allies and give each a role to defend the treehouse tonight.",image:"gazebo.jpg"},
    {id:7,title:"Tide of the Trampoline",items:"Sky Vision, Jump Count",locations:"Trampoline, Pool Deck",mission:"Slow controlled hops on the trampoline to 'scan' the lake. Call out five enemy positions.",image:"trampoline.jpg"},
    {id:8,title:"The Fence-Line Mystery",items:"Clue Finder, Track Reader",locations:"Backyard fence, Cul-de-sac",mission:"Walk the fence line and name five different sounds or sights. For each unique find, point and declare a trap location.",image:"culdesac.jpg"},
    {id:9,title:"Echoes Under the Deck",items:"Listening Shell, Flash Word",locations:"Front Deck, Under Back Deck",mission:"Sit quietly for 60 seconds and listen. Report any forest messages and use one message to make a plan.",image:"front_deck.jpg"},
    {id:10,title:"The Night of Many Lights",items:"Star Catcher, Glow Talk",locations:"Treehouse, Gazebo, Front Deck",mission:"Place imaginary lights by naming landmarks (count to 10). Each saved light gives one safe hour.",image:"treehouse.jpg"},
    {id:11,title:"The Pool‚Äôs Secret Gate",items:"Gate Riddle, Calm Breath",locations:"Pool, Gazebo",mission:"Create a riddle at the gazebo. If the riddle is solved, a calm path across the Pool of Shadows opens.",image:"pool.jpg"},
    {id:12,title:"Last Watch of the Cul-de-sac",items:"Banner of Dawn, Victory Call",locations:"Front Deck, Cul-de-sac, Treehouse",mission:"Make a victory signal (clap/song) from the front deck. If it's loud and proud, the forest retreats until morning.",image:"front_deck.jpg"}
  ];

  const daySelect = document.getElementById("daySelect");
  const selectedDayDisplay = document.getElementById("selectedDayDisplay");
  const scenarioTitle = document.getElementById("scenarioTitle");
  const itemsText = document.getElementById("itemsText");
  const locationText = document.getElementById("locationText");
  const missionText = document.getElementById("missionText");
  const scenarioImage = document.getElementById("scenarioImage");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const startBtn = document.getElementById("startBtn");
  const previewBtn = document.getElementById("previewBtn");
  const inventoryText = document.getElementById("inventoryText");
  const scanBtn = document.getElementById("scanBtn");
  const qrReader = document.getElementById("qr-reader");

  // ----- Inventory -----
  let inventory = JSON.parse(localStorage.getItem("inventory") || "[]");

  function addToInventory(item) {
    if (!inventory.includes(item)) {
      inventory.push(item);
      localStorage.setItem("inventory", JSON.stringify(inventory));
      updateInventoryUI();
      alert(`‚úÖ You found: ${item}!`);
    } else {
      alert(`Already in your bag: ${item}`);
    }
  }

  function updateInventoryUI() {
    inventoryText.value = inventory.join(", ") || "Empty";
  }

  // ----- Populate day selector -----
  scenarios.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = "Day " + s.id + " ‚Äî " + s.title;
    daySelect.appendChild(opt);
  });

  function showScenario(id){
    const s = scenarios.find(sc => sc.id==id);
    if(!s) return;
    selectedDayDisplay.textContent = "Day " + s.id;
    scenarioTitle.textContent = s.title;
    itemsText.value = s.items;
    locationText.value = s.locations;
    missionText.value = s.mission;
    if(s.image){
      scenarioImage.src = s.image;
      scenarioImage.style.display = "block";
    } else {
      scenarioImage.style.display = "none";
    }
    daySelect.value = id;
    localStorage.setItem("lastDay", id);
  }

  prevBtn.addEventListener("click",()=>{
    let id = Number(daySelect.value);
    id = id>1 ? id-1 : scenarios.length;
    showScenario(id);
  });
  nextBtn.addEventListener("click",()=>{
    let id = Number(daySelect.value);
    id = id<scenarios.length ? id+1 : 1;
    showScenario(id);
  });
  daySelect.addEventListener("change",()=> showScenario(daySelect.value));

  startBtn.addEventListener("click",()=>{
    const s = scenarios.find(sc => sc.id==daySelect.value);
    alert(`${s.title} ‚Äî ${s.mission}`);
  });

  previewBtn.addEventListener("click",()=>{
    const s = scenarios.find(sc => sc.id==daySelect.value);
    const text = `Mission for ${s.title}. Items: ${s.items}. Locations: ${s.locations}. Instructions: ${s.mission}`;
    if('speechSynthesis' in window){
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 0.95; utter.pitch = 1;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    } else {
      alert(text);
    }
  });

  // ----- QR Scanner -----
  let qrScanner = null;

  scanBtn.addEventListener("click", () => {
    if (qrReader.style.display === "none") {
      qrReader.style.display = "block";

      if (!qrScanner) {
        qrScanner = new Html5Qrcode("qr-reader");
      }

      qrScanner.start(
        { facingMode: "environment" }, // back camera
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          if (decodedText.startsWith("item:")) {
            const item = decodedText.split(":")[1];
            addToInventory(item);
          } else {
            alert("QR not recognized: " + decodedText);
          }
          qrScanner.stop();
          qrReader.style.display = "none";
        },
        (errorMessage) => { /* ignore scan errors */ }
      ).catch(err => {
        alert("Unable to start scanner: " + err);
      });

    } else {
      qrScanner.stop();
      qrReader.style.display = "none";
    }
  });

  // ----- Init -----
  const saved = localStorage.getItem("lastDay");
  showScenario(saved ? Number(saved) : 1);
  updateInventoryUI();

})();
</script>
</body>
</html>
