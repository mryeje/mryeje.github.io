<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>99 Nights ‚Äî Kid Mode (QR Adventure)</title>

<!-- QR scanner (drop-in from CDN; you can download and host locally for full offline) -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
  :root{
    --bg:#071621; --card:#0b1722; --accent:#6ee7b7; --muted:#9aa8bb; --glass: rgba(255,255,255,0.03);
    --good:#8ef08e; --bad:#ffb2b2; --gold:#ffd36b;
  }
  html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:linear-gradient(180deg,#04101a 0,#071621 100%);color:#eaf7f2;-webkit-font-smoothing:antialiased}
  .app{max-width:920px;margin:12px auto;padding:14px;display:grid;grid-template-columns:1fr 360px;gap:14px;box-sizing:border-box;}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{font-size:20px;margin:0;color:var(--accent)}
  .subtitle{color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(2,6,23,0.6)}
  /* left column content */
  .main{display:flex;flex-direction:column;gap:10px}
  .selector{display:flex;gap:8px;align-items:center}
  select{flex:1;padding:10px;border-radius:10px;border:none;font-size:16px;background:transparent;color:inherit}
  .big-btn{background:var(--accent);color:#042023;border:none;padding:12px;border-radius:12px;font-weight:800;font-size:16px;touch-action:manipulation}
  .big-icon-btn{background:transparent;border:2px solid var(--muted);color:var(--muted);padding:10px;border-radius:10px}
  .image-area{height:220px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  .title{font-size:18px;font-weight:800;color:var(--accent);margin:6px 0}
  label{font-size:13px;color:var(--muted);margin-bottom:6px}
  textarea{width:100%;min-height:56px;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;resize:vertical;font-size:14px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  /* right column */
  .side{display:flex;flex-direction:column;gap:10px}
  .panel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));min-height:64px}
  .inventory-list, .log-list{list-style:none;padding:0;margin:0;max-height:260px;overflow:auto}
  .inventory-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;margin-bottom:6px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.002))}
  .badge{padding:6px 8px;border-radius:8px;background:linear-gradient(90deg,var(--gold),#fff2a6);font-weight:700;color:#2b1900}
  /* scanner */
  #scanner{width:100%;height:300px;border-radius:10px;overflow:hidden;background:#000;display:none}
  /* event overlay for enemy chase */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;pointer-events:none}
  .overlay.show{display:flex;pointer-events:auto}
  .encounter{width:90%;max-width:720px;background:linear-gradient(180deg, rgba(3,8,12,0.95), rgba(5,10,16,0.95));border-radius:12px;padding:16px;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:flex;gap:12px;align-items:center}
  .enemy-icon{font-size:48px}
  .encounter-info{flex:1}
  .countdown{font-size:28px;font-weight:900;color:var(--gold)}
  .light-btn{background:#fff;color:#042023;padding:10px;border-radius:10px;border:none;font-weight:800}
  /* small helpers */
  .muted{color:var(--muted);font-size:13px}
  .sparkle{animation:pop 700ms ease;}
  @keyframes pop{0%{transform:scale(.85);opacity:0}60%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:rgba(3,7,8,0.9);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .health-bar{height:10px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;margin-top:6px}
  .health-fill{height:100%;background:linear-gradient(90deg,#66ff88,#2fb74a);width:100%}
  .muted-note{font-size:12px;color:var(--muted);margin-top:6px}
  @media (max-width:920px){
    .app{grid-template-columns:1fr; padding:12px}
    .image-area{height:180px}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>üå≤ 99 Nights ‚Äî Little Camp</h1>
        <div class="subtitle">A gentle forest adventure for explorers (age ~8). Scan QR tags to change the story!</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Health</div>
        <div class="card" style="padding:8px;border-radius:10px;text-align:center">
          <div id="healthLabel" style="font-weight:800">100%</div>
          <div class="health-bar"><div id="healthFill" class="health-fill" style="width:100%"></div></div>
          <div class="muted-note" id="statusNote">All good ‚Äî keep the campfire burning!</div>
        </div>
      </div>
    </header>

    <!-- left main -->
    <div class="main">
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <div class="title" id="scenarioTitle">Welcome to the Big Forest</div>
            <div class="muted">Choose a scenario or scan a tag to change the story.</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="big-icon-btn" id="prevBtn">‚óÄ</button>
            <select id="daySelect" aria-label="Pick a scenario"></select>
            <button class="big-icon-btn" id="nextBtn">‚ñ∂</button>
          </div>
        </div>

        <div class="image-area" id="imageArea" aria-hidden="true">
          <!-- for kid friendly version use emoji + simple art -->
          <div style="text-align:center">
            <div style="font-size:72px">üèïÔ∏è</div>
            <div class="muted">Your camp sits in a cozy clearing. At night, shadows move ‚Äî but light keeps them away.</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>üß∞ Scenario Items</label>
          <textarea id="itemsText" readonly></textarea>

          <label style="margin-top:8px">üìç Locations</label>
          <textarea id="locationText" readonly></textarea>

          <label style="margin-top:8px">üéØ Mission</label>
          <textarea id="missionText" readonly></textarea>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="big-btn" id="startBtn">Start Mission ‚ñ∂</button>
          <button class="big-btn" id="speakBtn">Read Aloud üìù</button>
          <button class="big-btn" id="scanBtn">Scan QR üì∑</button>
        </div>

        <div id="scanner" class="card" style="margin-top:12px;display:none">
          <div id="qr-reader" style="width:100%"></div>
          <div style="margin-top:8px;text-align:center">
            <button id="stopScan" class="big-icon-btn">Stop Scanner</button>
          </div>
        </div>

      </div>

      <!-- event log (left bottom) -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">üìñ Event Log</div>
          <div class="muted">Recent actions</div>
        </div>
        <div style="margin-top:8px">
          <ul id="eventLog" class="log-list"></ul>
        </div>
      </div>
    </div>

    <!-- right side -->
    <aside class="side">
      <div class="panel card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">üéí Inventory</div>
          <div class="muted">Tap items later to use</div>
        </div>
        <div style="margin-top:8px">
          <ul id="inventoryList" class="inventory-list"></ul>
        </div>
      </div>

      <div class="panel card">
        <div style="font-weight:800">üîç Quick Tips</div>
        <div class="muted" style="margin-top:8px">
          - Light keeps scary creatures away.<br>
          - Lantern lets you stop an enemy chase instantly.<br>
          - Forage gives food ‚Äî some finds are surprising!
        </div>
      </div>
    </aside>
  </div>

  <!-- encounter overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
    <div class="encounter" role="alert">
      <div class="enemy-icon" id="enemyEmoji" style="font-size:64px">üåë</div>
      <div class="encounter-info">
        <div style="font-size:18px;font-weight:800" id="encounterTitle">A shadow is near!</div>
        <div class="muted" id="encounterLine">Survive for <span class="countdown" id="countdown">10</span> sec or use a Lantern!</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
        <button id="useLightBtn" class="light-btn">Light Up üî¶</button>
        <button id="runAwayBtn" class="big-icon-btn">Try to Run</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
(() => {
  /* ----------------------------
     Kid-friendly scenario data
     ---------------------------- */
  const scenarios = [
    {id:1,title:"Camp Setup", items:"Campfire, Map", locations:"Treehouse, Front Deck", mission:"Make a cozy campsite and collect 3 sticks for the fire."},
    {id:2,title:"Lake Watch", items:"Whisper Map, Small Rope", locations:"Pool Deck, Dock", mission:"Walk the dock and name three shiny things you see in the water."},
    {id:3,title:"Trampoline Jump", items:"Sky Boots (imaginary), Stopwatch", locations:"Trampoline, Treehouse", mission:"Do 10 small jumps and count the clouds you see."},
    {id:4,title:"Gazebo Market", items:"Story Tokens", locations:"Gazebo, Garden", mission:"Tell two short stories to win a glowing badge."},
    {id:5,title:"Fence Patrol", items:"Clue Finder", locations:"Fence Line, Backyard", mission:"Walk the fence and find two new sounds or smells."}
  ];

  /* ---- game state ---- */
  let inventory = JSON.parse(localStorage.getItem("kid_inv") || "[]");
  let eventsLog = JSON.parse(localStorage.getItem("kid_log") || "[]");
  let health = Number(localStorage.getItem("kid_health") || "100");

  // enemy & forage lists (kid friendly)
  const enemies = [
    {name:"Shadow Deer", emoji:"ü¶å", line:"It doesn't like bright light!"},
    {name:"Giant Owl", emoji:"ü¶â", line:"It swoops when it's very dark."},
    {name:"Forest Tricksters", emoji:"üé≠", line:"Silly pranksters that steal stuff!"}
  ];
  const forageTable = [
    {text:"ü•ï A bunch of roots ‚Äî +5 food", effect:{health:+2}},
    {text:"üêá A rabbit ‚Äî +10 food", effect:{health:+6}},
    {text:"üçì Wild berries ‚Äî +5 health", effect:{health:+3}},
    {text:"üçÑ Strange mushrooms ‚Äî maybe safe? -5 health (ouch)", effect:{health:-5}},
    {text:"üå∞ Nuts ‚Äî +3 food", effect:{health:+1}}
  ];

  /* ---- DOM refs ---- */
  const daySelect = document.getElementById("daySelect");
  const selectedTitle = document.getElementById("scenarioTitle");
  const itemsText = document.getElementById("itemsText");
  const locationText = document.getElementById("locationText");
  const missionText = document.getElementById("missionText");
  const inventoryList = document.getElementById("inventoryList");
  const eventLog = document.getElementById("eventLog");
  const scanBtn = document.getElementById("scanBtn");
  const scannerWrap = document.getElementById("scanner");
  const qrReader = document.getElementById("qr-reader");
  const stopScanBtn = document.getElementById("stopScan");
  const overlay = document.getElementById("overlay");
  const encounterTitle = document.getElementById("encounterTitle");
  const encounterLine = document.getElementById("encounterLine");
  const enemyEmoji = document.getElementById("enemyEmoji");
  const countdownEl = document.getElementById("countdown");
  const useLightBtn = document.getElementById("useLightBtn");
  const runAwayBtn = document.getElementById("runAwayBtn");
  const toast = document.getElementById("toast");
  const healthLabel = document.getElementById("healthLabel");
  const healthFill = document.getElementById("healthFill");
  const statusNote = document.getElementById("statusNote");
  const startBtn = document.getElementById("startBtn");
  const speakBtn = document.getElementById("speakBtn");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  /* populate scenarios */
  scenarios.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `Day ${s.id} ‚Äî ${s.title}`;
    daySelect.appendChild(opt);
  });

  function showScenario(id){
    const s = scenarios.find(x=>x.id==id);
    if(!s) return;
    selectedTitle.textContent = s.title;
    itemsText.value = s.items;
    locationText.value = s.locations;
    missionText.value = s.mission;
    daySelect.value = id;
  }

  prevBtn.addEventListener("click",()=>{
    let id = Number(daySelect.value);
    id = id>1 ? id-1 : scenarios.length;
    showScenario(id);
  });
  nextBtn.addEventListener("click",()=>{
    let id = Number(daySelect.value);
    id = id<scenarios.length ? id+1 : 1;
    showScenario(id);
  });
  daySelect.addEventListener("change",()=> showScenario(daySelect.value));

  startBtn.addEventListener("click",()=>{
    const s = scenarios.find(sc => sc.id==daySelect.value);
    speakText(`${s.title}. Mission: ${s.mission}`);
    addEvent(`‚ñ∂ Started: ${s.title}`);
  });

  speakBtn.addEventListener("click",()=>{
    const s = scenarios.find(sc => sc.id==daySelect.value);
    speakText(`Mission for ${s.title}. Items: ${s.items}. Locations: ${s.locations}. Instructions: ${s.mission}`);
  });

  /* ----- inventory & logs UI ----- */
  function saveState(){ 
    localStorage.setItem("kid_inv", JSON.stringify(inventory));
    localStorage.setItem("kid_log", JSON.stringify(eventsLog));
    localStorage.setItem("kid_health", String(health));
  }

  function addEvent(text){
    const time = new Date().toLocaleTimeString();
    eventsLog.push(`${time} ‚Äî ${text}`);
    if(eventsLog.length>120) eventsLog.shift();
    renderLog();
    saveState();
  }

  function renderLog(){
    eventLog.innerHTML = "";
    eventsLog.slice().reverse().forEach(t => {
      const li = document.createElement("li");
      li.textContent = t;
      li.style.padding="6px 0";
      li.style.borderBottom="1px dashed rgba(255,255,255,0.03)";
      eventLog.appendChild(li);
    });
  }

  function renderInventory(){
    inventoryList.innerHTML = "";
    inventory.forEach((it,i) => {
      const li = document.createElement("li");
      li.className="inventory-item";
      li.innerHTML = `<div style="font-size:20px">${emojiForItem(it)}</div><div style="flex:1"><div style="font-weight:700">${it}</div><div class="muted">Tap to use</div></div>`;
      // use item on tap
      li.addEventListener("click",()=> useInventoryItem(i));
      inventoryList.appendChild(li);
    });
  }

  function emojiForItem(name){
    name = String(name).toLowerCase();
    if(name.includes("lantern")||name.includes("light")) return "üî¶";
    if(name.includes("map")) return "üó∫Ô∏è";
    if(name.includes("charm")||name.includes("lucky")) return "üçÄ";
    if(name.includes("boots")) return "üë¢";
    if(name.includes("meat")||name.includes("rabbit")) return "üçñ";
    return "üéÅ";
  }

  function useInventoryItem(index){
    const item = inventory[index];
    if(!item) return;
    if(item.toLowerCase().includes("lantern")){
      // simulate using lantern to heal/defeat immediate threat
      health = Math.min(100, health + 8);
      addEvent(`üî¶ Used ${item} ‚Äî light calmed the shadows!`);
      showToast(`${item} used ‚Äî light calmed the shadows!`);
      saveState();
      renderHealth();
    } else if(item.toLowerCase().includes("map")){
      addEvent(`üó∫Ô∏è Used ${item} ‚Äî found a safe path.`);
      showToast(`Old Map used ‚Äî you found a safe path!`);
    } else if(item.toLowerCase().includes("charm")){
      addEvent(`üçÄ ${item} gave you luck! Small health +3.`);
      health = Math.min(100, health + 3);
      renderHealth();
      saveState();
    } else {
      addEvent(`Used ${item}`);
    }
    // optionally remove used item (comment/uncomment)
    // inventory.splice(index,1);
    // renderInventory();
  }

  function showToast(text, dur=2200){
    toast.textContent = text;
    toast.style.display = "block";
    setTimeout(()=> toast.style.display = "none", dur);
  }

  /* ----- health UI ----- */
  function renderHealth(){
    healthLabel.textContent = `${Math.max(0,Math.round(health))}%`;
    healthFill.style.width = `${Math.max(0,health)}%`;
    if(health > 60) statusNote.textContent = "All good ‚Äî keep exploring!";
    else if(health > 30) statusNote.textContent = "A bit tired ‚Äî find food or rest.";
    else statusNote.textContent = "Low health ‚Äî be careful!";
    saveState();
  }

  /* ----- QR command handling ----- */
  function handleQRCommand(code){
    code = String(code).trim();
    addEvent(`Scanned: ${code}`);
    // item:NAME  -> add to inventory
    if(code.toLowerCase().startsWith("item:")){
      const item = code.split(":").slice(1).join(":").trim();
      if(item){
        if(!inventory.includes(item)){
          inventory.push(item);
          renderInventory();
          addEvent(`‚ú® Found item: ${item}`);
          showToast(`‚ú® ${item} added to your pack!`);
          speakText(`You found ${item}!`);
          saveState();
        } else {
          showToast(`${item} is already in your pack.`);
          addEvent(`${item} (already in pack)`);
        }
      }
      return;
    }

    // event:enemy_chase
    if(code.toLowerCase() === "event:enemy_chase"){
      startEnemyEncounter();
      return;
    }

    // forage -> random result
    if(code.toLowerCase() === "forage"){
      const pick = forageTable[Math.floor(Math.random()*forageTable.length)];
      // apply effect (health +/-)
      if(pick.effect && typeof pick.effect.health === "number"){
        health = Math.max(0, Math.min(100, health + pick.effect.health));
      }
      addEvent(`üå≤ Forage: ${pick.text}`);
      renderHealth();
      renderInventory();
      showToast(`üå≤ ${pick.text}`);
      speakText(`You foraged: ${pick.text}`);
      saveState();
      return;
    }

    // set:day=#
    if(code.toLowerCase().startsWith("set:day=")){
      const num = parseInt(code.split("=")[1],10);
      if(!isNaN(num)){
        const id = Math.min(Math.max(1,num),scenarios.length);
        showScenario(id);
        addEvent(`‚è≠ Jumped to Day ${id}`);
        showToast(`Jumped to Day ${id}`);
      }
      return;
    }

    // unknown
    addEvent(`‚ùì Unknown QR: ${code}`);
    showToast("That QR wasn't recognized.");
  }

  /* ----- enemy encounter flow ----- */
  let encounterTimer = null;
  let encounterSeconds = 0;
  function startEnemyEncounter(){
    // pick enemy
    const e = enemies[Math.floor(Math.random()*enemies.length)];
    enemyEmoji.textContent = e.emoji;
    encounterTitle.textContent = `Uh oh ‚Äî ${e.name} is near!`;
    encounterLine.textContent = `${e.line} Survive for `;
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    encounterSeconds = 12; // seconds to survive by default
    countdownEl.textContent = encounterSeconds;
    speakText(`${e.name} is near! Quick!`);
    addEvent(`‚ö†Ô∏è Encounter: ${e.name}`);

    // if player has Lantern in inventory, encourage use
    const hasLantern = inventory.some(x=> /lantern|light|lantern/i.test(x));
    useLightBtn.disabled = !hasLantern;
    useLightBtn.textContent = hasLantern ? "Light Up üî¶ (use Lantern)" : "No Lantern (Find light!)";

    // start countdown
    encounterTimer = setInterval(()=>{
      encounterSeconds -= 1;
      countdownEl.textContent = encounterSeconds;
      if(encounterSeconds <= 0){
        clearInterval(encounterTimer);
        endEncounter(false, e);
      }
    },1000);
  }

  function endEncounter(survived, enemy){
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    if(encounterTimer){ clearInterval(encounterTimer); encounterTimer = null; }
    if(survived){
      addEvent(`‚úÖ Escaped from ${enemy.name || "the shadow"}!`);
      showToast(`You escaped! Well done!`);
      speakText("You escaped! Nice work!");
      health = Math.min(100, health + 4);
    } else {
      // penalty
      addEvent(`üí• Caught by ${enemy.name || "the shadow"}! -10 health`);
      showToast(`Oops ‚Äî you were caught. -10 health`);
      speakText("Oh no! Be careful next time.");
      health = Math.max(0, health - 10);
    }
    renderHealth();
    saveState();
  }

  useLightBtn.addEventListener("click", ()=>{
    // consume lantern effect: don't remove from inventory but use effect
    const e = {name:"the shadow"};
    addEvent("üî¶ Lantern used during encounter.");
    showToast("Lantern bright! Shadows go away.");
    // immediate success
    endEncounter(true, e);
  });

  runAwayBtn.addEventListener("click", ()=>{
    // small chance to succeed based on health and luck (and charms)
    const luck = inventory.some(x=>/charm|lucky|luck/i.test(x)) ? 0.6 : 0.3;
    const chance = Math.random();
    const e = {name:"the shadow"};
    if(chance < luck || health > 70){
      endEncounter(true, e);
    } else {
      endEncounter(false, e);
    }
  });

  /* ----- scanner setup ----- */
  let html5QrcodeScanner = null;
  scanBtn.addEventListener("click", async ()=>{
    // show scanner div
    scannerWrap.style.display = "block";
    if(html5QrcodeScanner) return;
    html5QrcodeScanner = new Html5Qrcode("qr-reader", /* verbose= */ false);
    try {
      await html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: (window.innerWidth>600?300:200) },
        qrMessage => {
          // on success
          // stop scanning briefly to avoid duplicate reads
          if(html5QrcodeScanner) {
            html5QrcodeScanner.pause();
          }
          handleQRCommand(qrMessage.trim());
          // resume scanning after a second
          setTimeout(()=> {
            if(html5QrcodeScanner) html5QrcodeScanner.resume();
          }, 900);
        },
        errorMessage => {
          // ignore intermediate errors
        }
      );
    } catch(err){
      showToast("Camera couldn't start. Check permissions.");
      scannerWrap.style.display = "none";
      console.error(err);
    }
  });

  stopScanBtn.addEventListener("click", async ()=>{
    if(html5QrcodeScanner){
      try {
        await html5QrcodeScanner.stop();
        html5QrcodeScanner.clear();
      } catch(e){}
      html5QrcodeScanner = null;
    }
    scannerWrap.style.display = "none";
  });

  /* ----- helpers ----- */
  function speakText(text){
    try {
      if('speechSynthesis' in window){
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.95; u.pitch = 1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }
    } catch(e){}
  }

  /* ----- init UI ----- */
  function init(){
    const savedDay = Number(localStorage.getItem("kid_day") || 1);
    showScenario(savedDay);
    renderInventory();
    renderLog();
    renderHealth();
    // show saved inventory items visually
    // set event listeners for page lifecycle
    window.addEventListener("beforeunload", ()=> saveState());
  }
  init();

  // small "first run" welcome
  if(eventsLog.length === 0){
    addEvent("Welcome ‚Äî Scan a QR to start an adventure!");
    speakText("Welcome to Little Camp. Scan a QR tag to start an adventure!");
  }

})();
</script>
</body>
</html>
