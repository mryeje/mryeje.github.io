<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Profile DSL Demo (No Frameworks)</title>
<style>
  :root {
    --fg: #111;
    --bg: #fafafa;
    --card: #fff;
    --muted: #666;
    --accent: #3b82f6;
    --radius: 14px;
  }
  body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: var(--fg); }
  header { padding: 20px 24px; background: #fff; border-bottom: 1px solid #eee; position: sticky; top:0; z-index: 10; }
  header h1 { margin: 0 0 6px; font-size: 18px; }
  header .sub { color: var(--muted); font-size: 13px; }
  main { max-width: 960px; margin: 24px auto 64px; padding: 0 16px; }
  .card { background: var(--card); border: 1px solid #eee; border-radius: var(--radius); box-shadow: 0 1px 2px rgba(0,0,0,0.04); padding: 16px; margin-bottom: 16px; }
  fieldset { border: 1px dashed #e6e6e6; border-radius: 12px; padding: 12px 12px 8px; margin: 12px 0; }
  legend { font-weight: 600; padding: 0 6px; }
  label { font-weight: 600; display: block; margin: 10px 0 6px; }
  input[type="text"], textarea, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; outline: none; font-size: 14px; }
  textarea { min-height: 80px; resize: vertical; }
  .chips { display: flex; flex-wrap: wrap; gap: 8px; }
  .chip { border: 1px solid #ddd; padding: 8px 12px; border-radius: 999px; cursor: pointer; user-select: none; background: #fff; }
  .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
  @media (min-width: 700px) { .row.cols-2 { grid-template-columns: 1fr 1fr; } }
  .toolbar { display:flex; gap: 8px; }
  .btn { appearance: none; border: 1px solid #ddd; background: #fff; padding: 8px 12px; border-radius: 12px; cursor: pointer; font-weight: 600; }
  .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  .muted { color: var(--muted); font-size: 13px; }
  .hide { display: none !important; }
  .foot { margin-top: 8px; }
  .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #f3f4f6; padding: 6px 8px; border-radius: 8px; }
</style>
</head>
<body>
<header>
  <h1>Profile DSL Demo</h1>
  <div class="sub">A tiny, framework-free form renderer fed by a line-based spec. Copy this file or embed the script on your site.</div>
</header>

<main>
  <div class="card">
    <div class="toolbar">
      <button id="downloadAnswers" class="btn">Download answers JSON</button>
      <button id="resetForm" class="btn">Reset</button>
      <button id="loadMother" class="btn">Load Mother Profile Example</button>
      <button id="loadStartup" class="btn">Load Startup Team Example</button>
    </div>
    <div class="foot muted">Paste your DSL into the box below and click “Apply Spec”.</div>
  </div>

  <div class="card">
    <label for="dsl">Profile DSL (edit me):</label>
    <textarea id="dsl"></textarea>
    <div style="margin-top:8px" class="toolbar">
      <button id="applySpec" class="btn primary">Apply Spec</button>
      <span class="muted">Format: one directive per line (see examples below).</span>
    </div>
  </div>

  <div id="formMount" class="card"></div>

  <div class="card">
    <strong>Mini DSL</strong>
    <div class="muted">Each line is one directive. Quotes optional if no spaces.</div>
    <pre class="code" id="dslHelp"></pre>
  </div>
</main>

<script>
// ---------- Mini DSL Spec ----------
// Directives (one per line):
// FORM title="..." subject="..." audience="..." consent="..."
// SECTION id=identity title="Identity & Dates" columns=2
// Q type=text id=full_name section=identity label="Full name" required
// Q type=textarea id=bio section=identity label="Short bio"
// Q type=chips id=interests section=interests label="Core interests" options="Music|Movies|Books|Travel"
// Q type=chips id=music_genres section=interests label="Music genres" options="60s|70s|Rock|Pop" show_if="interests:any_of:Music"
// Q type=select id=country section=places label="Country" options="CA|US|UK"
// Q type=multiselect id=tools section=resources label="Tools stack" options="Premiere|After Effects|Blender|Notion"
// Q type=toggle id=privacy_optin section=privacy label="Allow sensitive items?"
// END

const helpText = `FORM title="Profile Builder" subject="Person" audience="Family" consent="You can skip any item."
SECTION id=identity title="Identity & Dates" columns=2
SECTION id=interests title="Interests" columns=2
SECTION id=places title="Places" columns=1
SECTION id=privacy title="Privacy" columns=1
Q type=text id=full_name section=identity label="Full name" required
Q type=text id=birthday section=identity label="Birthday (YYYY-MM-DD)"
Q type=chips id=interests_core section=interests label="Core interests" options="Music|Movies/TV|Books|Cooking|Gardening|Travel"
Q type=chips id=music_genres section=interests label="Music genres" options="60s|70s|80s|Rock|Pop|Jazz|Country" show_if="interests_core:any_of:Music"
Q type=textarea id=places_prior section=places label="Notable places lived (with rough years)"
Q type=toggle id=privacy_optin section=privacy label="Allow sensitive items?"
END`;

document.getElementById('dslHelp').textContent = helpText;

// ---------- Parser ----------
function parseLine(line) {
  const parts = line.trim().split(/\s+/);
  const directive = parts.shift();
  const rest = parts.join(' ');

  // Parse key=value pairs; value may be "quoted string" or bare token
  const kv = {};
  const rx = /(\w+)\s*=\s*("(?:[^"\\]|\\.)*"|[^"\s][^\s]*)/g;
  let m;
  while ((m = rx.exec(rest)) !== null) {
    let key = m[1];
    let val = m[2];
    if (val.startsWith('"') && val.endsWith('"')) {
      try { val = JSON.parse(val); } catch { val = val.slice(1,-1); }
    }
    kv[key] = val;
  }
  return { directive, ...kv };
}

function parseDSL(text) {
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l && !l.startsWith('#'));
  const form = { meta: {}, sections: [], questions: [] };
  for (const line of lines) {
    const { directive, ...kv } = parseLine(line);
    if (directive === 'FORM') {
      form.meta = kv;
    } else if (directive === 'SECTION') {
      form.sections.push({
        id: kv.id, title: kv.title || kv.id, columns: parseInt(kv.columns || '1', 10) || 1
      });
    } else if (directive === 'Q') {
      // normalize options -> array
      if (kv.options && typeof kv.options === 'string') {
        kv.options = kv.options.split('|').map(s => s.trim()).filter(Boolean);
      }
      // normalize show_if "a:any_of:Music|Books" or "toggle_id:equals:true"
      if (kv.show_if && typeof kv.show_if === 'string') {
        const [target, op, rest] = kv.show_if.split(':');
        let value = rest;
        if (op === 'any_of') value = rest.split('|').map(s => s.trim());
        form.questions.push({ ...kv, show_if: { target, op, value } });
      } else {
        form.questions.push(kv);
      }
    } else if (directive === 'END') {
      break;
    }
  }
  return form;
}

// ---------- Renderer ----------
function render(form, mount) {
  mount.innerHTML = "";
  const header = document.createElement('div');
  header.innerHTML = `<div><strong>${form.meta.title || 'Profile'}</strong> — <span class="muted">${form.meta.subject || ''}</span></div>
    <div class="muted">${form.meta.consent || 'You can skip any item.'}</div>`;
  mount.appendChild(header);

  const sectionMap = new Map();
  for (const s of form.sections) {
    const fs = document.createElement('fieldset');
    fs.dataset.sectionId = s.id;
    const legend = document.createElement('legend');
    legend.textContent = s.title;
    fs.appendChild(legend);
    const row = document.createElement('div');
    row.className = 'row ' + (s.columns >= 2 ? 'cols-2' : '');
    fs.appendChild(row);
    mount.appendChild(fs);
    sectionMap.set(s.id, row);
  }

  const state = {};
  const dependents = new Map(); // targetId -> list of question elements

  const createChip = (label) => {
    const b = document.createElement('span');
    b.className = 'chip';
    b.textContent = label;
    b.dataset.value = label;
    return b;
  };

  const controls = new Map(); // id -> control API {get,set,el,type}

  function addDependent(targetId, el, cond) {
    if (!dependents.has(targetId)) dependents.set(targetId, []);
    dependents.get(targetId).push({ el, cond });
  }

  function evalCondition(cond) {
    const { target, op, value } = cond;
    const ctrl = controls.get(target);
    if (!ctrl) return false;
    const current = ctrl.get();
    if (op === 'any_of') {
      if (!Array.isArray(current)) return false;
      return current.some(v => value.includes(v));
    }
    if (op === 'equals') {
      return String(current) === String(value);
    }
    return false;
  }

  function refreshVisibility(targetId) {
    const deps = dependents.get(targetId) || [];
    for (const { el, cond } of deps) {
      const ok = evalCondition(cond);
      el.classList.toggle('hide', !ok);
    }
  }

  for (const q of form.questions) {
    const wrap = document.createElement('div');
    wrap.className = 'cell';
    const label = document.createElement('label');
    label.textContent = q.label || q.id;
    wrap.appendChild(label);

    let inputEl;
    const id = q.id;
    const t = (q.type || 'text').toLowerCase();

    if (t === 'text') {
      inputEl = document.createElement('input');
      inputEl.type = 'text';
      inputEl.addEventListener('input', () => { state[id] = inputEl.value; });
      wrap.appendChild(inputEl);
      controls.set(id, { el: inputEl, type: t, get: () => inputEl.value, set: (v) => inputEl.value = v || "" });
    }
    else if (t === 'textarea') {
      inputEl = document.createElement('textarea');
      inputEl.addEventListener('input', () => { state[id] = inputEl.value; });
      wrap.appendChild(inputEl);
      controls.set(id, { el: inputEl, type: t, get: () => inputEl.value, set: (v) => inputEl.value = v || "" });
    }
    else if (t === 'toggle') {
      inputEl = document.createElement('input');
      inputEl.type = 'checkbox';
      inputEl.addEventListener('change', () => { state[id] = inputEl.checked; refreshVisibility(id); });
      const lab = document.createElement('div');
      lab.appendChild(inputEl);
      const span = document.createElement('span');
      span.style.marginLeft = "8px";
      span.textContent = q.label || q.id;
      lab.appendChild(span);
      wrap.innerHTML = "";
      wrap.appendChild(lab);
      controls.set(id, { el: inputEl, type: t, get: () => !!inputEl.checked, set: (v) => { inputEl.checked = !!v; refreshVisibility(id); } });
    }
    else if (t === 'chips') {
      const box = document.createElement('div');
      box.className = 'chips';
      const sel = new Set();
      for (const opt of (q.options || [])) {
        const chip = createChip(opt);
        chip.addEventListener('click', () => {
          if (chip.classList.contains('active')) { chip.classList.remove('active'); sel.delete(opt); }
          else { chip.classList.add('active'); sel.add(opt); }
          state[id] = Array.from(sel);
          refreshVisibility(id);
        });
        box.appendChild(chip);
      }
      wrap.appendChild(box);
      controls.set(id, { el: box, type: t, get: () => Array.from(sel), set: (arr) => {
        const want = new Set(arr || []);
        sel.clear();
        box.querySelectorAll('.chip').forEach(ch => {
          const v = ch.dataset.value;
          if (want.has(v)) { ch.classList.add('active'); sel.add(v); }
          else { ch.classList.remove('active'); }
        });
        refreshVisibility(id);
      }});
    }
    else if (t === 'select') {
      const sel = document.createElement('select');
      (q.options || []).forEach(opt => {
        const o = document.createElement('option');
        o.value = opt; o.textContent = opt;
        sel.appendChild(o);
      });
      sel.addEventListener('change', () => { state[id] = sel.value; refreshVisibility(id); });
      wrap.appendChild(sel);
      controls.set(id, { el: sel, type: t, get: () => sel.value, set: (v) => { sel.value = v || ""; refreshVisibility(id); } });
    }
    else if (t === 'multiselect') {
      const sel = document.createElement('select');
      sel.multiple = true;
      (q.options || []).forEach(opt => {
        const o = document.createElement('option');
        o.value = opt; o.textContent = opt;
        sel.appendChild(o);
      });
      sel.addEventListener('change', () => {
        const vals = Array.from(sel.selectedOptions).map(o => o.value);
        state[id] = vals; refreshVisibility(id);
      });
      wrap.appendChild(sel);
      controls.set(id, { el: sel, type: t, get: () => Array.from(sel.selectedOptions).map(o => o.value), set: (arr) => {
        const want = new Set(arr || []);
        Array.from(sel.options).forEach(o => { o.selected = want.has(o.value); });
        refreshVisibility(id);
      }});
    }
    else {
      const msg = document.createElement('div');
      msg.className = 'muted';
      msg.textContent = `Unsupported type: ${t}`;
      wrap.appendChild(msg);
    }

    // Conditional show_if
    if (q.show_if) {
      wrap.classList.add('hide'); // hidden until condition true
      addDependent(q.show_if.target, wrap, q.show_if);
    }

    const secRow = sectionMap.get(q.section || form.sections[0]?.id);
    (secRow || mount).appendChild(wrap);
  }

  // Initialize visibility from default state
  for (const [targetId] of dependents) refreshVisibility(targetId);

  // Export helper
  function download(data, filename = "answers.json") {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }

  // Wire toolbar
  document.getElementById('downloadAnswers').onclick = () => download(state, "answers.json");
  document.getElementById('resetForm').onclick = () => {
    for (const [id, api] of controls) {
      if (api.type === 'toggle') api.set(false);
      else if (api.type === 'chips') api.set([]);
      else if (api.type === 'multiselect') api.set([]);
      else api.set("");
    }
  };
}

// ---------- Examples ----------
const MOTHER_EXAMPLE = `FORM title="Mother Gift Profile" subject="Person" consent="You can skip any item."
SECTION id=identity title="Identity & Dates" columns=2
SECTION id=places title="Places" columns=1
SECTION id=interests title="Interests & Passions" columns=2
SECTION id=humor title="Humor" columns=1
SECTION id=dislikes title="Dislikes" columns=1
SECTION id=constraints title="Constraints" columns=2
SECTION id=directions title="Gift Directions" columns=1
Q type=text id=name section=identity label="What’s her name?"
Q type=text id=birthday section=identity label="Birthday (YYYY-MM-DD)"
Q type=text id=formative_places section=identity label="Where did she live during ~ages 7–14?"
Q type=text id=current_city section=places label="Current city/region & climate"
Q type=chips id=interests_core section=interests label="Core interests" options="Music|Movies/TV|Books|Cooking/Baking|Gardening|Travel|Fitness/Outdoors|Crafts/DIY|Tech/Gadgets|Games/Puzzles|Spiritual/Community|Pets/Animals|Sports|Collecting"
Q type=chips id=music_genres section=interests label="Music: favorite eras/genres" options="60s|70s|80s|90s|Rock|Pop|Jazz|Classical|Country|Folk|Soul/R&B" show_if="interests_core:any_of:Music"
Q type=textarea id=screen_favs section=interests label="Movies/TV: favorite titles/quotes" show_if="interests_core:any_of:Movies/TV"
Q type=chips id=humor_style section=humor label="Sense of humor" options="Dry/deadpan|Witty/wordplay|Physical/slapstick|Heartwarming|Satire|Dark (lightly)|Clean only"
Q type=chips id=hard_nos section=dislikes label="Hard nos" options="Scented items|Cluttery knick-knacks|Novelty gadgets|Expensive consumables|Brand logos|Noisy devices|Religious themes|Alcohol-related"
Q type=chips id=constraints_set section=constraints label="Practical constraints" options="Budget|Limited space|Prefers low-maintenance|Mobility/energy limits|Tech-light|Sustainability-focused|None"
Q type=chips id=directions_first section=directions label="Explore first" options="Experiences/classes|Personalized keepsake|Practical upgrade|Wellness/comfort|Nostalgia-themed|Art/creative tools|Charity/cause-aligned"
END`;

const STARTUP_EXAMPLE = `FORM title="Startup Team Profile" subject="Organization" consent="You can skip any item."
SECTION id=identity title="Identity" columns=2
SECTION id=stack title="Tools/Stack" columns=2
SECTION id=goals title="Goals & KPIs" columns=2
SECTION id=audience title="Audience & ICP" columns=2
SECTION id=directions title="Research Directions" columns=1
Q type=text id=team_name section=identity label="Team name"
Q type=text id=company section=identity label="Company"
Q type=chips id=stack_tools section=stack label="Core tools" options="Premiere|After Effects|Blender|Notion|Slack|Asana|Figma|DaVinci Resolve"
Q type=chips id=goals_kpis section=goals label="Primary goals/KPIs" options="Watch time|CTR|Conversion|Retention|Lead quality|Engagement rate"
Q type=chips id=audience_icp section=audience label="Audience/ICP" options="DIY Homeowners|Prosumer Video Editors|Enterprise Marketers|SMB Owners|Students"
Q type=chips id=directions_first section=directions label="Explore first" options="Comparative landscape|How-to guides|Case studies|Tooling/workflow|Risks/pitfalls"
END`;

// Prefill text area
document.getElementById('dsl').value = MOTHER_EXAMPLE;

// Wire buttons
document.getElementById('applySpec').onclick = () => {
  try {
    const spec = parseDSL(document.getElementById('dsl').value);
    const mount = document.getElementById('formMount');
    render(spec, mount);
  } catch (e) {
    alert("Parse error: " + e.message);
  }
};
document.getElementById('loadMother').onclick = () => { document.getElementById('dsl').value = MOTHER_EXAMPLE; };
document.getElementById('loadStartup').onclick = () => { document.getElementById('dsl').value = STARTUP_EXAMPLE; };

// Auto-apply on load
document.getElementById('applySpec').click();
</script>
</body>
</html>
